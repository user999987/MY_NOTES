转自 阮一峰

## 作用
SSL/TLS
不使用 SSL/TLS 的HTTP通信 是明文传播 3 大风险
1. eavesdropping
2. tampering
3. pretending

SSL/TLS 为了解决风险而设计
1. 加密传播 - 第三方无法窃听
2. 校验机制 - 一旦篡改，通信双方会立刻发现
3. 配备身份证书，防止身份被冒充

## 历史
1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布。\
1995年，NetScape公司发布SSL 2.0版，很快发现有严重漏洞。\
1996年，SSL 3.0版问世，得到大规模应用。\
1999年，互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版TLS 1.0版。\
2006年和2008年，TLS进行了两次升级，分别为TLS 1.1版和TLS 1.2版。最新的变动是2011年TLS 1.2的修订版。

目前，应用最广泛的是TLS 1.0，接下来是SSL 3.0。但是，主流浏览器都已经实现了TLS 1.2的支持。
TLS 1.0通常被标示为SSL 3.1，TLS 1.1为SSL 3.2，TLS 1.2为SSL 3.3。

## 基本运行过程
SSL/TLS协议的基本思路是采用公钥加密法，也就是说，客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

1. 如何保证公钥不被篡改
将公钥放在数字证书 (public key certificate, also known as a digital certificate or identity certificate. electronic document used to prove the ownership of a public key) 中，只要证书是可信的，公钥就是可信的

2. 公钥加密计算量大， 如何减少耗用的时间
每个 session 用对称加密加密信息，但是用公钥加密 session key

## handshake 详细过程
![driver program](./handshake.png)

1. ClientHello
在这一步，客户端主要向服务器提供以下信息。
* 支持的协议版本， 比如 TLS 1.0
* 一个客户端生成的随机数，稍后用语生成 session key
* 支持的加密方法 比如 RSA 公钥加密
* 支持的压缩方法

2. ServerHello
* 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
* 一个服务器生成的随机数，稍后用于生成"对话密钥"。
* 确认使用的加密方法，比如RSA公钥加密。
* 服务器证书

除了上面这些信息，如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供"客户端证书"。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。

3. 客户端回应
客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。

如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。
* 一个随机数。该随机数用服务器公钥加密，防止被窃听。
* 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
* 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称"pre-master key"。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把"会话密钥"。

4. Server 最后回应
服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的"会话密钥"。然后，向客户端最后发送下面信息。
* 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
* 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用"会话密钥"加密内容。

握手阶段的通信都是明文传递，最重要的一点就是<span style="color:red">当 Client 收到 Server 的公钥之后，发送了第三个随机数，这个随机数是被 公钥 加密的</span>。 两个 plain text 的随机数 加上一个被 公钥 加密的随机数。3个随机数用来做对称加密的 密钥。此密钥被服务端 公钥 加密来保证信息传递的 安全 和效率

5. Session 的恢复
握手阶段用来建立SSL连接。如果出于某种原因，对话中断，就需要重新握手。\
这时有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。\
session ID 是服务端保存 session 信息
session ticket 是客户端保存 session 信息